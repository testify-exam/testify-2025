<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Create & Manage Notifications</title>
    <style>
      :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --light-bg: #f5f7ff;
        --text-color: #333;
        --shadow: 0 4px 6px rgba(67, 97, 238, 0.1);
        --border-radius: 18px;
      }


        button, a {
          -webkit-tap-highlight-color: transparent;  
          outline: none; }

      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body { 
        font-family: sans-serif;
        background-color: var(--light-bg);
        color: var(--text-color);
        line-height: 1.6;
        font-size: 14px;
        padding-top: 20px;
      }
      
      .container { 
        max-width: 800px; 
        margin: 20px auto; 
        padding: 20px;
      }
      
      .card {
    background: #ffffff00;
    border-radius: var(--border-radius);
    padding: 10px;
    margin-bottom: 0px;
}
      
h2, h3 {
    color: var(--primary-color);
    margin-bottom: 0;
    font-size: 20px;
}
      
      label {
    display: block;
    margin-top: 10px;
    font-weight: 500;
    margin-left: 3px;
}
      
      select, textarea {
        width: 100%;
        padding: 9px;
        margin-top: 8px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-size: 13px;
        transition: border 0.3s;
        font-family: system-ui;
      }
      
      select:focus, textarea:focus {
        outline: none;
        border-color: var(--primary-color);
      }
      
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      
      button {
        width: 100%;
        padding: 12px;
        margin-top: 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      
      
      
      .notif-list {
    margin-top: 15px;
    height: 280px;
    overflow-y: auto;
}
      
      .notif-item {
        background: white;
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        animation: fadeIn 0.5s ease-in;
      }
      
      .notif-message {
    display: flex;
    flex-direction: column-reverse;
    align-items: flex-start;
    flex-wrap: wrap;
}
      
      .notif-date {
        color: #777;
        font-size: 0.7em;
        display: block;
        margin-top: 5px;
      }
      
      .delete-btn {
    background-color: #ffe4e41f;
    color: #ff3c3c;
    border: 1px solid #ff5f5f;
    padding: 8px 12px;
    border-radius: var(--border-radius);
    cursor: pointer;
    margin-left: 10px;
    width: auto;
    transition: background-color 0.3s;
    font-weight: 500;
}
      
      
      
      /* Custom Alert & Confirm Styles */
      .custom-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      
      .modal-content {
        background: white;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 400px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
      }
      
      .modal-title {
        color: var(--primary-color);
        margin-bottom: 15px;
      }
      
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        flex-direction: column-reverse;
    }
      
      .modal-btn {
        padding: 12px 16px;
        border-radius: var(--border-radius);
        font-weight: 500;
        cursor: pointer;
        width: auto;
        margin-top: 0;
      }
      
      .btn-confirm {
        background-color: var(--primary-color);
        color: white;
        border: none;
      }
      
      .btn-cancel {
        background-color: #f1f1f1;
        color: #333;
        border: none;
      }
      
      /* Loading Spinner */
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }
      .filter-spinner {
        position: relative;
    /* transform: translateY(-50%); */
    width: 25px;
    height: 25px;
    border: 3px solid rgba(67, 97, 238, 0.3);
    border-radius: 50%;
    border-top-color: #ffffff;
    opacity: 0;
    visibility: hidden;
    animation: spin 0.8s linear infinite;
    transition: opacity 0.3s, visibility 0.3s;
    pointer-events: none;
    margin-left: 7px;
}

        #filterForm.filtering .filter-spinner {
            opacity: 1;
            visibility: visible;
        }

        @keyframes spin {
            to {
                transform: translateY(-50%) rotate(360deg);
            }
        }

      
      /* Animations */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(10px); }
      }
      
      @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Responsive Styles */
      @media (max-width: 768px) {
        .container {
          padding: 0px;
          margin: 0px;
          width: auto;
        }
        
        .notif-item {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .delete-btn {
          margin-left: 0;
          margin-top: 10px;
          width: 100%;
        }
      }
      .com-box-sel {
    display: flex;
    flex-wrap: wrap;
    flex-direction: row;
    gap: 11px;
}
    </style>
</head>
<body>
    <div class="container" id="filterForm">
        <div class="card">
          <div style="padding-bottom: 9px; border-bottom: 1px solid rgb(59, 59, 59); display: flex;justify-content: space-between;align-items: center; margin-bottom: 10px;"><h2>Manage Notifications</h2><a href="/" style="text-decoration: none;
            color: white;background-color: #4361ee;padding: 3px 9px 2px 4px;border-radius: 20px;display: flex;align-items: center;" ><svg width="28px" height="28px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M17 12L8 12" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M11 8L7 12L11 16" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>Back<div class="filter-spinner"></div></a></div>
            <form id="notificationForm" method="POST" action="/api/notifications/send">
              <div class="com-box-sel"><div><label for="target">Send to:</label>
                <select id="target" name="target" required onchange="toggleDepartmentDropdown()">
                    {% if user_role == 'admin' %}
                        <option value="all_teachers">All Teachers</option>
                    {% endif %}
                    <option value="all_students">All Students</option>
                    <option value="department">Department Wise</option>
                </select></div>
            
                <div id="departmentSelect" style="display: none;">
                    <label for="department">Select Department:</label>
                    <select id="department" name="department_id">
                        {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div></div>
            
                <label for="message">Message:</label>
                <textarea id="message" name="message" required placeholder="Enter your notification message here..."></textarea>
            
                <button type="submit" id="submitBtn">Send Notification</button>
            </form>
        </div>

        <div class="card">
            <h3>Existing Notifications</h3>
            <div class="notif-list" id="notificationList">
                {% for notif in notifications %}
                    <div class="notif-item" id="notif-{{ notif.id }}">
                        <div class="notif-message">
                            {{ notif.message }}
                            <span class="notif-date" data-timestamp="{{ notif.created_at }}"></span>
                        </div>
                        <button class="delete-btn" onclick="deleteNotification({{ notif.id }})">Delete</button>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="custom-modal" id="alertModal">
        <div class="modal-content">
            <h3 class="modal-title">Notification</h3>
            <p id="alertMessage"></p>
            <div class="modal-buttons">
                <button class="modal-btn btn-confirm" onclick="closeAlertModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div class="custom-modal" id="confirmModal">
        <div class="modal-content">
            <h3 class="modal-title">Confirm Action</h3>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="cancelConfirmAction()">Cancel</button>
                <button class="modal-btn btn-confirm" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Store form selection state
        let formState = {
            target: "",
            department: "",
            message: ""
        };
        
        // Initialize the page
        document.addEventListener("DOMContentLoaded", function() {
            // Get stored form values from localStorage if available
            const savedState = localStorage.getItem('notificationFormState');
            if (savedState) {
                formState = JSON.parse(savedState);
                document.getElementById("target").value = formState.target;
                document.getElementById("message").value = formState.message;
                
                // Show department dropdown if needed
                toggleDepartmentDropdown();
                
                if (formState.department) {
                    document.getElementById("department").value = formState.department;
                }
            }
        });
        
        // Toggle department dropdown based on selection
        function toggleDepartmentDropdown() {
            let target = document.getElementById("target").value;
            document.getElementById("departmentSelect").style.display = (target === "department") ? "block" : "none";
            
            // Update form state
            formState.target = target;
            localStorage.setItem('notificationFormState', JSON.stringify(formState));
        }
        
        // Form submission with loading animation
        document.getElementById("notificationForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            
            // Save form state
            formState.message = document.getElementById("message").value;
            if (document.getElementById("departmentSelect").style.display === "block") {
                formState.department = document.getElementById("department").value;
            }
            localStorage.setItem('notificationFormState', JSON.stringify(formState));
            
            // Show loading state
            const submitBtn = document.getElementById("submitBtn");
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner"></span>Sending...';
            submitBtn.disabled = true;
    
            let formData = new FormData(this);
    
            try {
                let response = await fetch("/api/notifications/send", {
                    method: "POST",
                    body: formData
                });
        
                let result = await response.json();
        
                if (response.ok) {
                    showCustomAlert("Notification sent successfully!");
                    
                    // Add the new notification to the list with animation
                    const newNotif = {
                        id: result.id || Date.now(), // Use returned ID or timestamp as fallback
                        message: formData.get("message"),
                        created_at: new Date().toLocaleString()
                    };
                    
                    addNotificationToList(newNotif);
                    
                    // Clear form but preserve the selected target
                    const currentTarget = document.getElementById("target").value;
                    this.reset();
                    document.getElementById("target").value = currentTarget;
                    formState.message = "";
                    localStorage.setItem('notificationFormState', JSON.stringify(formState));
                } else {
                    showCustomAlert("Error: " + result.detail);
                }
            } catch (error) {
                showCustomAlert("An error occurred while sending the notification.");
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });
        
        // Add a notification to the list with animation
        function addNotificationToList(notification) {
            const list = document.getElementById("notificationList");
            const notifItem = document.createElement("div");
            notifItem.className = "notif-item";
            notifItem.id = `notif-${notification.id}`;
            
            notifItem.innerHTML = `
                <div class="notif-message">
                    ${notification.message}
                    <span class="notif-date">${notification.created_at}</span>
                </div>
                <button class="delete-btn" onclick="deleteNotification(${notification.id})">Delete</button>
            `;
            
            list.prepend(notifItem);
        }
        
        // Delete notification with confirmation and animation
        function deleteNotification(notificationId) {
            showCustomConfirm(
                "Are you sure you want to delete this notification?",
                async function() {
                    const notifElement = document.getElementById(`notif-${notificationId}`);
                    
                    try {
                        // Start delete animation
                        notifElement.style.animation = "fadeOut 0.5s ease-out forwards";
                        
                        const response = await fetch(`/api/notifications/${notificationId}/delete`, {
                            method: "DELETE"
                        });
            
                        // Wait for animation to complete
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        if (response.ok) {
                            notifElement.remove();
                            showCustomAlert("Notification deleted successfully!");
                        } else {
                            // Show the element again if delete failed
                            notifElement.style.animation = "fadeIn 0.5s ease-in forwards";
                            const result = await response.json();
                            showCustomAlert("Error: " + result.detail);
                        }
                    } catch (error) {
                        // Show the element again if delete failed
                        notifElement.style.animation = "fadeIn 0.5s ease-in forwards";
                        showCustomAlert("An error occurred while trying to delete the notification.");
                    }
                }
            );
        }
        
        // Custom alert modal
        function showCustomAlert(message) {
            document.getElementById("alertMessage").textContent = message;
            document.getElementById("alertModal").style.display = "flex";
        }
        
        function closeAlertModal() {
            document.getElementById("alertModal").style.display = "none";
        }
        
        // Custom confirm modal
        let confirmCallback = null;
        
        function showCustomConfirm(message, callback) {
            document.getElementById("confirmMessage").textContent = message;
            document.getElementById("confirmModal").style.display = "flex";
            confirmCallback = callback;
            
            // Set up confirm button
            document.getElementById("confirmActionBtn").onclick = function() {
                document.getElementById("confirmModal").style.display = "none";
                if (confirmCallback) confirmCallback();
            };
        }
        
        function cancelConfirmAction() {
            document.getElementById("confirmModal").style.display = "none";
        }
        
        // Close modals when clicking outside content
        window.onclick = function(event) {
            const alertModal = document.getElementById("alertModal");
            const confirmModal = document.getElementById("confirmModal");
            
            if (event.target === alertModal) {
                alertModal.style.display = "none";
            }
            
            if (event.target === confirmModal) {
                confirmModal.style.display = "none";
            }
        };

        function formatDateToIST(timestamp) {
        let date = new Date(timestamp);
        
        // Convert to UTC milliseconds and add 5:30 hours (19800000 ms)
        date = new Date(date.getTime() + (5.5 * 60 * 60 * 1000));

        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        let year = date.getFullYear();
        let hours = String(date.getHours()).padStart(2, '0');
        let minutes = String(date.getMinutes()).padStart(2, '0');

        return `${day}-${month}-${year} ${hours}:${minutes}`;
    }

    // Format all notification dates
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.notif-date').forEach(el => {
            let timestamp = el.getAttribute('data-timestamp');
            if (timestamp) {
                el.textContent = formatDateToIST(timestamp);
            }
        });
    });
    function showloading(){
      document.getElementById('filterForm').classList.add('filtering');
    }
    function hideLoading(){
      document.getElementById('filterForm').classList.remove('filtering');
    }
    window.addEventListener('beforeunload', function() {
        showloading();
        });
    </script>
</body>
</html>
